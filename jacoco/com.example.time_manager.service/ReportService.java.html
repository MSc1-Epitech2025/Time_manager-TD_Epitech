<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReportService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">time-manager</a> &gt; <a href="index.source.html" class="el_package">com.example.time_manager.service</a> &gt; <span class="el_source">ReportService.java</span></div><h1>ReportService.java</h1><pre class="source lang-java linenums">package com.example.time_manager.service;

import java.util.List;

import org.springframework.security.access.AccessDeniedException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.time_manager.dto.report.ReportCreateRequest;
import com.example.time_manager.dto.report.ReportResponse;
import com.example.time_manager.dto.report.ReportUpdateRequest;
import com.example.time_manager.model.Report;
import com.example.time_manager.model.User;
import com.example.time_manager.repository.ReportRepository;
import com.example.time_manager.repository.UserRepository;

import jakarta.persistence.EntityNotFoundException;

/**
 * Business logic for Reports:
 * - Any authenticated user can create a report to ANY target user
 * - Author can update/delete their own reports; ADMIN can manage all
 * - Visibility: a report is visible to its author, its target, or an ADMIN
 */
@Service
@Transactional
public class ReportService {

  private final ReportRepository reportRepo;
  private final UserRepository userRepo;

<span class="fc" id="L32">  public ReportService(ReportRepository reportRepo, UserRepository userRepo) {</span>
<span class="fc" id="L33">    this.reportRepo = reportRepo;</span>
<span class="fc" id="L34">    this.userRepo = userRepo;</span>
<span class="fc" id="L35">  }</span>

  /* ======================== CREATE ======================== */

  public ReportResponse createForAuthorEmail(String authorEmail, ReportCreateRequest req) {
<span class="fc" id="L40">    User author = userByEmail(authorEmail);</span>

<span class="fc" id="L42">    User target = userRepo.findById(req.getTargetUserId())</span>
<span class="fc" id="L43">        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Target user not found: &quot; + req.getTargetUserId()));</span>

<span class="fc" id="L45">    Report r = new Report();</span>
<span class="fc" id="L46">    r.setAuthor(author);</span>
<span class="fc" id="L47">    r.setTarget(target);</span>

<span class="fc bfc" id="L49" title="All 4 branches covered.">    if (req.getSubjectUserId() != null &amp;&amp; !req.getSubjectUserId().isBlank()) {</span>
<span class="fc" id="L50">      User subject = userRepo.findById(req.getSubjectUserId())</span>
<span class="fc" id="L51">          .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Subject user not found: &quot; + req.getSubjectUserId()));</span>
<span class="fc" id="L52">      r.setSubject(subject);</span>
    }

<span class="fc" id="L55">    r.setType(&quot;MANUAL&quot;);</span>
<span class="fc" id="L56">    r.setSeverity(&quot;INFO&quot;);</span>
<span class="fc" id="L57">    r.setRuleKey(null);</span>

<span class="fc" id="L59">    r.setTitle(req.getTitle());</span>
<span class="fc" id="L60">    r.setBody(req.getBody());</span>

<span class="fc" id="L62">    r = reportRepo.save(r);</span>
<span class="fc" id="L63">    return toDto(r);</span>
  }

  /* ======================== READ ======================== */

  @Transactional(readOnly = true)
  public List&lt;ReportResponse&gt; listAllForAdmin(String email) {
<span class="fc" id="L70">    User me = userByEmail(email);</span>
<span class="fc" id="L71">    requireAdmin(me);</span>

<span class="fc" id="L73">    return reportRepo.findAllByOrderByCreatedAtDesc()</span>
<span class="fc" id="L74">        .stream().map(this::toDto).toList();</span>
  }

  @Transactional(readOnly = true)
  public List&lt;ReportResponse&gt; listAuthoredByEmail(String email) {
<span class="fc" id="L79">    User me = userByEmail(email);</span>
<span class="fc" id="L80">    return reportRepo.findByAuthor_IdOrderByCreatedAtDesc(me.getId())</span>
<span class="fc" id="L81">        .stream().map(this::toDto).toList();</span>
  }

  @Transactional(readOnly = true)
  public List&lt;ReportResponse&gt; listReceivedByEmail(String email) {
<span class="fc" id="L86">    User me = userByEmail(email);</span>
<span class="fc" id="L87">    return reportRepo.findByTarget_IdOrderByCreatedAtDesc(me.getId())</span>
<span class="fc" id="L88">        .stream().map(this::toDto).toList();</span>
  }

  @Transactional(readOnly = true)
  public ReportResponse getVisibleTo(String email, Long id) {
<span class="fc" id="L93">    Report r = reportRepo.findById(id)</span>
<span class="pc" id="L94">        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Report not found: &quot; + id));</span>

<span class="fc" id="L96">    User me = userByEmail(email);</span>

<span class="fc bfc" id="L98" title="All 6 branches covered.">    if (isAdmin(me) || isAuthor(me, r) || isTarget(me, r)) {</span>
<span class="fc" id="L99">      return toDto(r);</span>
    }

<span class="fc" id="L102">    throw new AccessDeniedException(&quot;Forbidden&quot;);</span>
  }

  /* ======================== UPDATE / DELETE ======================== */

  public ReportResponse updateVisibleTo(String email, Long id, ReportUpdateRequest req) {
<span class="fc" id="L108">    Report r = reportRepo.findById(id)</span>
<span class="pc" id="L109">        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Report not found: &quot; + id));</span>

<span class="fc" id="L111">    User me = userByEmail(email);</span>

<span class="fc bfc" id="L113" title="All 4 branches covered.">    if (!(isAdmin(me) || isAuthor(me, r))) {</span>
<span class="fc" id="L114">      throw new AccessDeniedException(&quot;Forbidden&quot;);</span>
    }

<span class="fc bfc" id="L117" title="All 2 branches covered.">    if (req.getTitle() != null) r.setTitle(req.getTitle());</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">    if (req.getBody() != null)  r.setBody(req.getBody());</span>

<span class="fc" id="L120">    r = reportRepo.save(r);</span>
<span class="fc" id="L121">    return toDto(r);</span>
  }

  public void deleteVisibleTo(String email, Long id) {
<span class="fc" id="L125">    Report r = reportRepo.findById(id)</span>
<span class="fc" id="L126">        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Report not found: &quot; + id));</span>

<span class="fc" id="L128">    User me = userByEmail(email);</span>

<span class="fc bfc" id="L130" title="All 4 branches covered.">    if (!(isAdmin(me) || isAuthor(me, r))) {</span>
<span class="fc" id="L131">      throw new AccessDeniedException(&quot;Forbidden&quot;);</span>
    }

<span class="fc" id="L134">    reportRepo.deleteById(id);</span>
<span class="fc" id="L135">  }</span>

  /* ======================== Mapping ======================== */

  private ReportResponse toDto(Report r) {
<span class="fc" id="L140">    ReportResponse dto = new ReportResponse();</span>

<span class="fc" id="L142">    dto.setId(r.getId());</span>
<span class="fc" id="L143">    dto.setTitle(r.getTitle());</span>
<span class="fc" id="L144">    dto.setBody(r.getBody());</span>
<span class="fc" id="L145">    dto.setCreatedAt(r.getCreatedAt());</span>
<span class="fc" id="L146">    dto.setUpdatedAt(r.getUpdatedAt());</span>

<span class="fc" id="L148">    dto.setAuthorId(r.getAuthor().getId());</span>
<span class="fc" id="L149">    dto.setAuthorEmail(r.getAuthor().getEmail());</span>

<span class="fc" id="L151">    dto.setTargetUserId(r.getTarget().getId());</span>
<span class="fc" id="L152">    dto.setTargetEmail(r.getTarget().getEmail());</span>

<span class="fc" id="L154">    dto.setType(r.getType());</span>
<span class="fc" id="L155">    dto.setSeverity(r.getSeverity());</span>

<span class="fc bfc" id="L157" title="All 2 branches covered.">    if (r.getSubject() != null) {</span>
<span class="fc" id="L158">      dto.setSubjectUserId(r.getSubject().getId());</span>
<span class="fc" id="L159">      dto.setSubjectEmail(r.getSubject().getEmail());</span>
    } else {
<span class="fc" id="L161">      dto.setSubjectUserId(null);</span>
<span class="fc" id="L162">      dto.setSubjectEmail(null);</span>
    }

<span class="fc" id="L165">    return dto;</span>
  }

  /* ======================== Helpers ======================== */

  private User userByEmail(String email) {
<span class="fc" id="L171">    return userRepo.findByEmail(email)</span>
<span class="fc" id="L172">        .orElseThrow(() -&gt; new EntityNotFoundException(&quot;User not found: &quot; + email));</span>
  }

  private boolean isAuthor(User me, Report r) {
<span class="fc bfc" id="L176" title="All 4 branches covered.">    return r.getAuthor() != null &amp;&amp; r.getAuthor().getId().equals(me.getId());</span>
  }

  private boolean isTarget(User me, Report r) {
<span class="fc bfc" id="L180" title="All 4 branches covered.">    return r.getTarget() != null &amp;&amp; r.getTarget().getId().equals(me.getId());</span>
  }

  private void requireAdmin(User me) {
<span class="fc bfc" id="L184" title="All 2 branches covered.">    if (!isAdmin(me)) throw new AccessDeniedException(&quot;Admin only&quot;);</span>
<span class="fc" id="L185">  }</span>

  private boolean isAdmin(User u) {
<span class="fc" id="L188">    return hasRole(u, &quot;ADMIN&quot;);</span>
  }

  private boolean hasRole(User u, String roleUpper) {
<span class="fc" id="L192">    String raw = u.getRole();</span>
<span class="fc bfc" id="L193" title="All 4 branches covered.">    if (raw == null || raw.isBlank()) return false;</span>

<span class="fc" id="L195">    String wanted = roleUpper.toUpperCase();</span>

<span class="fc" id="L197">    String normalized = raw</span>
<span class="fc" id="L198">        .replace(&quot;[&quot;, &quot;&quot;)</span>
<span class="fc" id="L199">        .replace(&quot;]&quot;, &quot;&quot;)</span>
<span class="fc" id="L200">        .replace(&quot;\&quot;&quot;, &quot;&quot;)</span>
<span class="fc" id="L201">        .trim()</span>
<span class="fc" id="L202">        .toUpperCase();</span>

<span class="fc bfc" id="L204" title="All 2 branches covered.">    for (String p : normalized.split(&quot;,&quot;)) {</span>
<span class="fc" id="L205">      String r = p.trim();</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">      if (r.equals(wanted)) return true;</span>

<span class="pc bpc" id="L208" title="3 of 4 branches missed.">      if (wanted.equals(&quot;MANAGER&quot;) &amp;&amp; r.contains(&quot;MANAGER&quot;)) return true;</span>
<span class="pc bpc" id="L209" title="1 of 4 branches missed.">      if (wanted.equals(&quot;ADMIN&quot;) &amp;&amp; r.contains(&quot;ADMIN&quot;)) return true;</span>
<span class="pc bpc" id="L210" title="3 of 4 branches missed.">      if (wanted.equals(&quot;EMPLOYEE&quot;) &amp;&amp; r.contains(&quot;EMPLOYEE&quot;)) return true;</span>
    }
<span class="fc" id="L212">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>
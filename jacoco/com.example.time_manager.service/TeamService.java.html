<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TeamService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">time-manager</a> &gt; <a href="index.source.html" class="el_package">com.example.time_manager.service</a> &gt; <span class="el_source">TeamService.java</span></div><h1>TeamService.java</h1><pre class="source lang-java linenums">package com.example.time_manager.service;

import com.example.time_manager.dto.team.TeamDto;
import com.example.time_manager.model.Team;
import com.example.time_manager.model.TeamMember;
import com.example.time_manager.model.User;
import com.example.time_manager.repository.TeamMemberRepository;
import com.example.time_manager.repository.TeamRepository;
import com.example.time_manager.repository.UserRepository;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.EntityNotFoundException;
import jakarta.validation.Valid;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;

/**
 * Business logic for Teams &amp; Members with role-based access:
 *
 * - ADMIN: - can list all teams (allTeams) - can create/update/delete teams -
 * can add/remove team members everywhere
 *
 * - MANAGER (global role) AND member of the target team: - can add/remove
 * members in that team
 *
 * - EMPLOYEE (or any authenticated member of the target team): - can view team
 * members of their own teams
 *
 * - &quot;MyTeams&quot;: teams where current user is a member (any role) -
 * &quot;MyManagedTeams&quot;: teams where current user is a member AND has global MANAGER
 * role
 *
 * Notes: - User.role is stored as JSON String (e.g.
 * [&quot;employee&quot;,&quot;manager&quot;,&quot;admin&quot;]) - User.id is a String UUID (CHAR(36))
 */
@Service
@Transactional
public class TeamService {

    private final TeamRepository teamRepo;
    private final TeamMemberRepository teamMemberRepo;
    private final UserRepository userRepo;

<span class="fc" id="L48">    private final ObjectMapper objectMapper = new ObjectMapper();</span>

    public TeamService(TeamRepository teamRepo,
            TeamMemberRepository teamMemberRepo,
<span class="fc" id="L52">            UserRepository userRepo) {</span>
<span class="fc" id="L53">        this.teamRepo = teamRepo;</span>
<span class="fc" id="L54">        this.teamMemberRepo = teamMemberRepo;</span>
<span class="fc" id="L55">        this.userRepo = userRepo;</span>
<span class="fc" id="L56">    }</span>

    /* ===================== Queries ===================== */
    /**
     * Public-ish list of teams (you can further restrict if needed).
     */
    public List&lt;Team&gt; findAll() {
<span class="fc" id="L63">        return teamRepo.findAll();</span>
    }

    /**
     * Find a team by ID or throw 404.
     */
    public Team findById(Long id) {
<span class="fc" id="L70">        return teamRepo.findById(id)</span>
<span class="fc" id="L71">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Team not found: &quot; + id));</span>
    }

    /**
     * ADMIN-only: list all teams.
     */
    public List&lt;Team&gt; findAllForAdmin() {
<span class="fc" id="L78">        requireAdmin();</span>
<span class="fc" id="L79">        return teamRepo.findAll();</span>
    }

    /**
     * Teams where the current user is a member.
     */
    public List&lt;Team&gt; findTeamsOfCurrentUser() {
<span class="fc" id="L86">        String me = currentUserId();</span>
<span class="fc" id="L87">        List&lt;Long&gt; teamIds = teamMemberRepo.findTeamIdsByUserId(me);</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">        return teamIds.isEmpty() ? List.of() : teamRepo.findAllById(teamIds);</span>
    }

    /**
     * Teams where the current user is a member and has global MANAGER role. (We
     * reuse &quot;myTeams&quot; and simply require the MANAGER role.)
     */
    public List&lt;Team&gt; findManagedByCurrentUser() {
<span class="fc" id="L96">        requireRole(&quot;MANAGER&quot;);</span>
<span class="fc" id="L97">        return findTeamsOfCurrentUser();</span>
    }

    /**
     * List members of a given team. Allowed for ADMIN or any user who is a
     * member of that team.
     */
    public List&lt;User&gt; listMembers(Long teamId) {
<span class="fc" id="L105">        assertCanViewTeamMembers(teamId);</span>
<span class="fc" id="L106">        return teamMemberRepo.findUsersByTeamId(teamId);</span>
    }
    
    /**
     * Among a team's members, return the ones whose global role contains
     * &quot;manager&quot;.
     */
    public List&lt;User&gt; listTeamManagers(Long teamId) {
<span class="fc" id="L114">        assertCanViewTeamMembers(teamId);</span>
<span class="fc" id="L115">        List&lt;User&gt; members = teamMemberRepo.findUsersByTeamId(teamId);</span>
<span class="fc" id="L116">        return members.stream().filter(u -&gt; hasGlobalRole(u, &quot;manager&quot;)).toList();</span>
    }

    /* ===================== Mutations ===================== */
    /**
     * Create a team. ADMIN-only by default.
     */
    public Team create(@Valid TeamDto dto) {
<span class="fc" id="L124">        requireAdmin();</span>
<span class="fc" id="L125">        Team t = new Team();</span>
<span class="fc" id="L126">        t.setName(dto.getName());</span>
<span class="fc" id="L127">        t.setDescription(dto.getDescription());</span>
<span class="fc" id="L128">        return teamRepo.save(t);</span>
    }

    /**
     * Update a team. ADMIN-only by default. If you want to allow MANAGER
     * members to update name/description, relax this check accordingly (e.g.,
     * assertCanManageTeamMembers(id)).
     */
    public Team update(Long id, @Valid TeamDto dto) {
<span class="fc" id="L137">        requireAdmin();</span>
<span class="fc" id="L138">        Team t = findById(id);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (dto.getName() != null) {</span>
<span class="fc" id="L140">            t.setName(dto.getName());</span>
        }
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        if (dto.getDescription() != null) {</span>
<span class="fc" id="L143">            t.setDescription(dto.getDescription());</span>
        }
<span class="fc" id="L145">        return teamRepo.save(t);</span>
    }

    /**
     * Delete a team. ADMIN-only.
     */
    public void delete(Long id) {
<span class="fc" id="L152">        requireAdmin();</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (!teamRepo.existsById(id)) {</span>
<span class="fc" id="L154">            throw new EntityNotFoundException(&quot;Team not found: &quot; + id);</span>
        }
<span class="fc" id="L156">        teamRepo.deleteById(id);</span>
<span class="fc" id="L157">    }</span>

    /**
     * Add a member to a team. Allowed for ADMIN, or MANAGER who is also a
     * member of the team.
     */
    public void addMember(Long teamId, String userId) {
<span class="fc" id="L164">        assertCanManageTeamMembers(teamId);</span>

<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (teamMemberRepo.existsByTeam_IdAndUser_Id(teamId, userId)) {</span>
<span class="fc" id="L167">            return;</span>
        }

<span class="fc" id="L170">        Team team = teamRepo.findById(teamId)</span>
<span class="fc" id="L171">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;Team not found: &quot; + teamId));</span>
<span class="fc" id="L172">        User user = userRepo.findById(userId)</span>
<span class="fc" id="L173">                .orElseThrow(() -&gt; new EntityNotFoundException(&quot;User not found: &quot; + userId));</span>

<span class="fc" id="L175">        TeamMember tm = new TeamMember();</span>
<span class="fc" id="L176">        tm.setTeam(team); // uses relationship field, not primitive ID</span>
<span class="fc" id="L177">        tm.setUser(user); // uses relationship field, not primitive ID</span>
<span class="fc" id="L178">        teamMemberRepo.save(tm);</span>
<span class="fc" id="L179">    }</span>

    /**
     * Remove a member from a team. Allowed for ADMIN, or MANAGER who is also a
     * member of the team.
     */
    public void removeMember(Long teamId, String userId) {
<span class="fc" id="L186">        assertCanManageTeamMembers(teamId);</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">        if (!teamMemberRepo.existsByTeam_IdAndUser_Id(teamId, userId)) {</span>
<span class="fc" id="L188">            return;</span>
        }
<span class="fc" id="L190">        teamMemberRepo.deleteByTeam_IdAndUser_Id(teamId, userId);</span>
<span class="fc" id="L191">    }</span>

    /* ===================== AuthZ Helpers ===================== */
    private String currentUserId() {
<span class="fc" id="L195">        var auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="pc bpc" id="L196" title="1 of 4 branches missed.">        if (auth == null || auth.getName() == null) {</span>
<span class="fc" id="L197">            throw new SecurityException(&quot;Unauthenticated&quot;);</span>
        }
<span class="fc" id="L199">        String subject = auth.getName();</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">        if (subject.contains(&quot;@&quot;)) {</span>
<span class="fc" id="L201">            return userRepo.findByEmail(subject)</span>
<span class="fc" id="L202">                    .map(User::getId)</span>
<span class="pc" id="L203">                    .orElseThrow(() -&gt; new IllegalStateException(&quot;No user for email subject: &quot; + subject));</span>
        }

        // Otherwise assume subject is already the UUID
<span class="fc" id="L207">        return subject;</span>
    }

    /**
     * True if current principal has ROLE_ADMIN.
     */
    private boolean isAdmin() {
<span class="fc" id="L214">        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="pc bpc" id="L215" title="2 of 4 branches missed.">        return auth != null &amp;&amp; auth.getAuthorities() != null</span>
<span class="fc" id="L216">                &amp;&amp; auth.getAuthorities().stream()</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">                        .anyMatch(a -&gt; &quot;ROLE_ADMIN&quot;.equals(a.getAuthority()));</span>
    }

    /**
     * True if current principal has ROLE_MANAGER.
     */
    private boolean isManager() {
<span class="fc" id="L224">        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="pc bpc" id="L225" title="2 of 4 branches missed.">        return auth != null &amp;&amp; auth.getAuthorities() != null</span>
<span class="fc" id="L226">                &amp;&amp; auth.getAuthorities().stream()</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                        .anyMatch(a -&gt; &quot;ROLE_MANAGER&quot;.equals(a.getAuthority()));</span>
    }

    /**
     * Enforce ADMIN role.
     */
    private void requireAdmin() {
<span class="fc bfc" id="L234" title="All 2 branches covered.">        if (!isAdmin()) {</span>
<span class="fc" id="L235">            throw new SecurityException(&quot;Forbidden: requires ADMIN&quot;);</span>
        }
<span class="fc" id="L237">    }</span>

    /**
     * Enforce a given high-level role (expects upper-case like &quot;MANAGER&quot;). It
     * maps to Spring Security authorities prefixed with &quot;ROLE_&quot;.
     */
    private void requireRole(String roleUpper) {
<span class="fc" id="L244">        Authentication auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="pc bpc" id="L245" title="2 of 4 branches missed.">        if (auth == null || auth.getAuthorities() == null) {</span>
<span class="nc" id="L246">            throw new SecurityException(&quot;Unauthenticated&quot;);</span>
        }
<span class="fc" id="L248">        String expected = &quot;ROLE_&quot; + roleUpper;</span>
<span class="fc" id="L249">        boolean ok = auth.getAuthorities().stream()</span>
<span class="fc" id="L250">                .anyMatch(a -&gt; expected.equals(a.getAuthority()));</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">        if (!ok) {</span>
<span class="fc" id="L252">            throw new SecurityException(&quot;Forbidden: requires &quot; + expected);</span>
        }
<span class="fc" id="L254">    }</span>

    /**
     * Check if a user entity has a given global role (roles stored as JSON
     * string). Example JSON: [&quot;employee&quot;,&quot;manager&quot;,&quot;admin&quot;]
     */

<span class="fc" id="L261">    private boolean isMemberOf(Long teamId, String userId) { return teamMemberRepo.existsByTeam_IdAndUser_Id(teamId, userId); }</span>

    private boolean hasGlobalRole(User u, String roleLower) {
<span class="fc" id="L264">        String roleRaw = u.getRole();</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        if (roleRaw == null) {</span>
<span class="nc" id="L266">            return false;</span>
        }

        try {
            // Si c'est du JSON (ex: [&quot;employee manager&quot;] ou [&quot;employee&quot;,&quot;manager&quot;])
<span class="fc" id="L271">            java.util.List&lt;String&gt; roles = objectMapper.readValue(</span>
<span class="fc" id="L272">                    roleRaw, new com.fasterxml.jackson.core.type.TypeReference&lt;java.util.List&lt;String&gt;&gt;() {</span>
            });
<span class="fc" id="L274">            return roles.stream()</span>
<span class="fc" id="L275">                    .filter(java.util.Objects::nonNull)</span>
<span class="fc" id="L276">                    .flatMap(r -&gt; java.util.Arrays.stream(r.split(&quot;[\\s,;|]+&quot;)))</span>
<span class="fc" id="L277">                    .anyMatch(t -&gt; roleLower.equalsIgnoreCase(t));</span>
<span class="fc" id="L278">        } catch (Exception ignore) {</span>
            // Pas JSON -&gt; on split directement
<span class="fc" id="L280">            return java.util.Arrays.stream(roleRaw.split(&quot;[\\s,;|]+&quot;))</span>
<span class="fc" id="L281">                    .anyMatch(t -&gt; roleLower.equalsIgnoreCase(t));</span>
        }
    }

    /**
     * Allow viewing team members if: - current user is ADMIN, or - current user
     * is a member of the team.
     */
    private void assertCanViewTeamMembers(Long teamId) {
<span class="fc" id="L290">        String me = currentUserId();</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">        if (isAdmin()) {</span>
<span class="fc" id="L292">            return;</span>
        }
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (isMemberOf(teamId, me)) {</span>
<span class="fc" id="L295">            return;</span>
        }
<span class="fc" id="L297">        throw new SecurityException(&quot;Forbidden: not allowed to view members of this team&quot;);</span>
    }

    /**
     * Allow managing team members if: - current user is ADMIN, or - current
     * user is MANAGER and a member of the team.
     */
    private void assertCanManageTeamMembers(Long teamId) {
<span class="fc" id="L305">        String me = currentUserId();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">        if (isAdmin()) {</span>
<span class="fc" id="L307">            return;</span>
        }
<span class="pc bpc" id="L309" title="2 of 4 branches missed.">        if (isManager() &amp;&amp; isMemberOf(teamId, me)) {</span>
<span class="nc" id="L310">            return;</span>
        }
<span class="fc" id="L312">        throw new SecurityException(&quot;Forbidden: only ADMIN or MANAGER member of the team can modify members&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>
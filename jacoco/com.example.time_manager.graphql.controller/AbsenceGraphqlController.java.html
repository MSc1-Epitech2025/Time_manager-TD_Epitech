<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbsenceGraphqlController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">time-manager</a> &gt; <a href="index.source.html" class="el_package">com.example.time_manager.graphql.controller</a> &gt; <span class="el_source">AbsenceGraphqlController.java</span></div><h1>AbsenceGraphqlController.java</h1><pre class="source lang-java linenums">package com.example.time_manager.graphql.controller;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.graphql.data.method.annotation.Argument;
import org.springframework.graphql.data.method.annotation.MutationMapping;
import org.springframework.graphql.data.method.annotation.QueryMapping;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;

import com.example.time_manager.dto.absence.AbsenceCreateRequest;
import com.example.time_manager.dto.absence.AbsenceResponse;
import com.example.time_manager.dto.absence.AbsenceStatusUpdateRequest;
import com.example.time_manager.dto.absence.AbsenceUpdateRequest;
import com.example.time_manager.model.absence.AbsencePeriod;
import com.example.time_manager.model.absence.AbsenceStatus;
import com.example.time_manager.model.absence.AbsenceType;
import com.example.time_manager.service.AbsenceService;

import jakarta.annotation.Nullable;

@PreAuthorize(&quot;isAuthenticated()&quot;)
@Controller
public class AbsenceGraphqlController {

  private final AbsenceService absenceService;

<span class="fc" id="L33">  public AbsenceGraphqlController(AbsenceService absenceService) {</span>
<span class="fc" id="L34">    this.absenceService = absenceService;</span>
<span class="fc" id="L35">  }</span>


  private String currentEmail() {
<span class="fc" id="L39">    var auth = SecurityContextHolder.getContext().getAuthentication();</span>
<span class="fc bfc" id="L40" title="All 4 branches covered.">    if (auth == null || !auth.isAuthenticated()) {</span>
<span class="fc" id="L41">      throw new SecurityException(&quot;Unauthenticated&quot;);</span>
    }
<span class="fc" id="L43">    Object principal = auth.getPrincipal();</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">    if (principal instanceof UserDetails u) {</span>
<span class="fc" id="L45">      return u.getUsername();</span>
    }
<span class="fc" id="L47">    return auth.getName();</span>
  }

  private static Map&lt;LocalDate, AbsencePeriod&gt; toMap(List&lt;PeriodByDateInput&gt; periodList) {
<span class="fc" id="L51">    Map&lt;LocalDate, AbsencePeriod&gt; m = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">    if (periodList != null) {</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">      for (PeriodByDateInput p : periodList) {</span>
<span class="fc" id="L54">        m.put(LocalDate.parse(p.getDate()), p.getPeriod());</span>
<span class="fc" id="L55">      }</span>
    }
<span class="fc" id="L57">    return m;</span>
  }

  /* ======================== Queries ====================== */

  @QueryMapping
  public List&lt;AbsenceResponse&gt; myAbsences() {
<span class="fc" id="L64">    return absenceService.listMine(currentEmail());</span>
  }

  @QueryMapping
  public AbsenceResponse absence(@Argument Long id) {
<span class="fc" id="L69">    return absenceService.getVisibleTo(currentEmail(), id);</span>
  }

  @QueryMapping
  @PreAuthorize(&quot;hasAuthority('MANAGER') or hasAuthority('ADMIN')&quot;)
  public List&lt;AbsenceResponse&gt; absencesByUser(@Argument String userId) {
<span class="fc" id="L75">    return absenceService.listForUser(userId);</span>
  }

  @QueryMapping
  public List&lt;AbsenceResponse&gt; allAbsences() {
<span class="fc" id="L80">    return absenceService.listAll();</span>
  }

  @QueryMapping
  public List&lt;AbsenceResponse&gt; myTeamAbsences(@Argument @Nullable Long teamId) {
<span class="fc" id="L85">    return absenceService.listTeamAbsences(currentEmail(), teamId);</span>
  }

  @QueryMapping
  public List&lt;AbsenceResponse&gt; teamAbsences(@Argument Long teamId) {
<span class="nc" id="L90">    return absenceService.listTeamAbsences(teamId);</span>
  }

  /* ======================= Mutations ===================== */

  @MutationMapping
  public AbsenceResponse createAbsence(@Argument AbsenceCreateInput input) {
<span class="fc" id="L97">    AbsenceCreateRequest req = new AbsenceCreateRequest();</span>
<span class="fc" id="L98">    req.setStartDate(LocalDate.parse(input.getStartDate()));</span>
<span class="fc" id="L99">    req.setEndDate(LocalDate.parse(input.getEndDate()));</span>
<span class="fc" id="L100">    req.setType(input.getType());</span>
<span class="fc" id="L101">    req.setReason(input.getReason());</span>
<span class="fc" id="L102">    req.setSupportingDocumentUrl(input.getSupportingDocumentUrl());</span>
<span class="fc" id="L103">    req.setPeriodByDate(toMap(input.getPeriodByDate()));</span>
<span class="fc" id="L104">    return absenceService.createForEmail(currentEmail(), req);</span>
  }

  @MutationMapping
  public AbsenceResponse updateAbsence(@Argument Long id, @Argument AbsenceUpdateInput input) {
<span class="fc" id="L109">    AbsenceUpdateRequest req = new AbsenceUpdateRequest();</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">    if (input.getStartDate() != null) req.setStartDate(LocalDate.parse(input.getStartDate()));</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">    if (input.getEndDate() != null) req.setEndDate(LocalDate.parse(input.getEndDate()));</span>
<span class="fc" id="L112">    req.setType(input.getType());</span>
<span class="fc" id="L113">    req.setReason(input.getReason());</span>
<span class="fc" id="L114">    req.setSupportingDocumentUrl(input.getSupportingDocumentUrl());</span>
<span class="fc" id="L115">    req.setPeriodByDate(toMap(input.getPeriodByDate()));</span>
<span class="fc" id="L116">    return absenceService.updateVisibleTo(currentEmail(), id, req);</span>
  }

  @MutationMapping
  @PreAuthorize(&quot;hasAuthority('MANAGER') or hasAuthority('ADMIN')&quot;)
  public AbsenceResponse setAbsenceStatus(@Argument Long id, @Argument AbsenceStatusUpdateInput input) {
<span class="fc" id="L122">    AbsenceStatusUpdateRequest req = new AbsenceStatusUpdateRequest();</span>
<span class="fc" id="L123">    req.setStatus(input.getStatus());</span>
<span class="fc" id="L124">    return absenceService.setStatus(currentEmail(), id, req);</span>
  }

  @MutationMapping
  public Boolean deleteAbsence(@Argument Long id) {
<span class="fc" id="L129">    absenceService.deleteVisibleTo(currentEmail(), id);</span>
<span class="fc" id="L130">    return true;</span>
  }

  /* ========== Input ========== */

  public static class AbsenceCreateInput {
    private String startDate;                 // yyyy-MM-dd
    private String endDate;                   // yyyy-MM-dd
    private AbsenceType type;
    private String reason;
    private String supportingDocumentUrl;
    private List&lt;PeriodByDateInput&gt; periodByDate;

<span class="fc" id="L143">    public AbsenceCreateInput() {}</span>

<span class="fc" id="L145">    public String getStartDate() { return startDate; }</span>
<span class="fc" id="L146">    public void setStartDate(String startDate) { this.startDate = startDate; }</span>

<span class="fc" id="L148">    public String getEndDate() { return endDate; }</span>
<span class="fc" id="L149">    public void setEndDate(String endDate) { this.endDate = endDate; }</span>

<span class="fc" id="L151">    public AbsenceType getType() { return type; }</span>
<span class="fc" id="L152">    public void setType(AbsenceType type) { this.type = type; }</span>

<span class="fc" id="L154">    public String getReason() { return reason; }</span>
<span class="fc" id="L155">    public void setReason(String reason) { this.reason = reason; }</span>

<span class="fc" id="L157">    public String getSupportingDocumentUrl() { return supportingDocumentUrl; }</span>
<span class="fc" id="L158">    public void setSupportingDocumentUrl(String supportingDocumentUrl) { this.supportingDocumentUrl = supportingDocumentUrl; }</span>

<span class="fc" id="L160">    public List&lt;PeriodByDateInput&gt; getPeriodByDate() { return periodByDate; }</span>
<span class="fc" id="L161">    public void setPeriodByDate(List&lt;PeriodByDateInput&gt; periodByDate) { this.periodByDate = periodByDate; }</span>
  }

  public static class AbsenceUpdateInput {
    private String startDate;                 // nullable
    private String endDate;                   // nullable
    private AbsenceType type;                 // nullable
    private String reason;                    // nullable
    private String supportingDocumentUrl;     // nullable
    private List&lt;PeriodByDateInput&gt; periodByDate; // nullable

<span class="fc" id="L172">    public AbsenceUpdateInput() {}</span>

<span class="fc" id="L174">    public String getStartDate() { return startDate; }</span>
<span class="fc" id="L175">    public void setStartDate(String startDate) { this.startDate = startDate; }</span>

<span class="fc" id="L177">    public String getEndDate() { return endDate; }</span>
<span class="fc" id="L178">    public void setEndDate(String endDate) { this.endDate = endDate; }</span>

<span class="fc" id="L180">    public AbsenceType getType() { return type; }</span>
<span class="fc" id="L181">    public void setType(AbsenceType type) { this.type = type; }</span>

<span class="fc" id="L183">    public String getReason() { return reason; }</span>
<span class="fc" id="L184">    public void setReason(String reason) { this.reason = reason; }</span>

<span class="fc" id="L186">    public String getSupportingDocumentUrl() { return supportingDocumentUrl; }</span>
<span class="fc" id="L187">    public void setSupportingDocumentUrl(String supportingDocumentUrl) { this.supportingDocumentUrl = supportingDocumentUrl; }</span>

<span class="fc" id="L189">    public List&lt;PeriodByDateInput&gt; getPeriodByDate() { return periodByDate; }</span>
<span class="fc" id="L190">    public void setPeriodByDate(List&lt;PeriodByDateInput&gt; periodByDate) { this.periodByDate = periodByDate; }</span>
  }

  public static class AbsenceStatusUpdateInput {
    private AbsenceStatus status;

<span class="fc" id="L196">    public AbsenceStatusUpdateInput() {}</span>

<span class="fc" id="L198">    public AbsenceStatus getStatus() { return status; }</span>
<span class="fc" id="L199">    public void setStatus(AbsenceStatus status) { this.status = status; }</span>
  }

  public static class PeriodByDateInput {
    private String date;          // yyyy-MM-dd
    private AbsencePeriod period; // AM/PM/FULL_DAY

<span class="fc" id="L206">    public PeriodByDateInput() {}</span>

<span class="fc" id="L208">    public String getDate() { return date; }</span>
<span class="fc" id="L209">    public void setDate(String date) { this.date = date; }</span>

<span class="fc" id="L211">    public AbsencePeriod getPeriod() { return period; }</span>
<span class="fc" id="L212">    public void setPeriod(AbsencePeriod period) { this.period = period; }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>
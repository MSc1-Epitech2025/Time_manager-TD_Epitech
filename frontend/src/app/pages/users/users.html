<div class="users-page">
  <main class="main-content">
    <!-- Header Card -->
    <mat-card class="header-card" appearance="outlined">
      <mat-card-content>
        <div class="header-section">
          <div class="header-info">
            <h1 class="page-title">User Management</h1>
            <p class="page-subtitle">Manage and monitor all users in the system</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="content-wrapper">
      <!-- Left side: User List -->
      <section class="user-list-section">
        <!-- Search Card -->
        <mat-card class="search-card" appearance="outlined">
          <mat-card-content>
            <div class="search-section">
              <mat-form-field appearance="outline" class="search-field">
                <mat-label>Search for a user</mat-label>
                <input matInput type="text" [(ngModel)]="searchTerm" (ngModelChange)="searchUsers()"
                  placeholder="Name or email..." />
                <mat-icon matPrefix>search</mat-icon>
              </mat-form-field>

              <button mat-raised-button class="create-btn" (click)="showCreateForm()">
                <mat-icon>person_add</mat-icon>
                <span>Create User</span>
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Loading or error status -->
        <mat-card *ngIf="isLoading || lastError" class="status-card" appearance="outlined">
          <mat-card-content>
            <div *ngIf="isLoading" class="loading-spinner">
              <mat-icon class="spin">refresh</mat-icon>
              <p>Loading users...</p>
            </div>
            <div *ngIf="!isLoading && lastError" class="error-state">
              <mat-icon>error_outline</mat-icon>
              <p>{{ lastError }}</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- User list Card -->
        <mat-card class="users-list-card" appearance="outlined" *ngIf="!isLoading && !lastError">
          <mat-card-content class="users-list-content">
            <mat-list *ngIf="filteredUsers.length > 0" class="users-list">
              <mat-list-item *ngFor="let user of filteredUsers; let last = last" class="user-item"
                [class.selected]="selectedUser?.id === user.id" (click)="selectUser(user)">
                <div matListItemTitle class="user-item-content">
                  <div class="user-avatar">
                    {{ user.firstName.charAt(0).toUpperCase() }}{{ user.lastName.charAt(0).toUpperCase() }}
                  </div>
                  <div class="user-info">
                    <div class="user-name">{{ user.firstName }} {{ user.lastName }}</div>
                    <div class="user-email">{{ user.email }}</div>
                  </div>
                </div>
                <mat-divider *ngIf="!last"></mat-divider>
              </mat-list-item>
            </mat-list>

            <div *ngIf="filteredUsers.length === 0" class="empty-state">
              <mat-icon>group_off</mat-icon>
              <p>No users to display</p>
            </div>
          </mat-card-content>
        </mat-card>
      </section>

      <!-- Right side: User Form -->
      <section class="user-form-section" *ngIf="showForm">
        <mat-card class="form-card" appearance="outlined" #userFormSection>
          <mat-card-header>
            <mat-card-title>
              <mat-icon>{{ isCreating ? 'person_add' : 'edit' }}</mat-icon>
              {{ isCreating ? 'Create User' : 'Edit User' }}
            </mat-card-title>
            <button mat-icon-button class="close-btn" (click)="cancelForm()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-card-header>
          <mat-card-content>
            <form class="user-form" #userForm="ngForm">
              <mat-form-field appearance="outline">
                <mat-label>First Name</mat-label>
                <input matInput [(ngModel)]="formData.firstName" name="firstName" required />
                <mat-icon matPrefix>person</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Last Name</mat-label>
                <input matInput [(ngModel)]="formData.lastName" name="lastName" required />
                <mat-icon matPrefix>person</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Email</mat-label>
                <input matInput type="email" [(ngModel)]="formData.email" name="email" 
                  required email pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}" #emailField="ngModel" />
                <mat-icon matPrefix>email</mat-icon>
                <mat-error *ngIf="emailField.invalid && emailField.touched">
                  <span *ngIf="emailField.errors?.['required']">Email is required</span>
                  <span *ngIf="emailField.errors?.['email'] || emailField.errors?.['pattern']">Please enter a valid email (address@mail.domain)</span>
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Phone</mat-label>
                <input matInput type="tel" [(ngModel)]="formData.phone" name="phone" />
                <mat-icon matPrefix>phone</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Role</mat-label>
                <mat-select [(ngModel)]="formData.role" name="role" required>
                  <mat-option value="">Select a role</mat-option>
                  <mat-option value="EMPLOYEE">Employee</mat-option>
                  <mat-option value="MANAGER">Manager</mat-option>
                </mat-select>
                <mat-icon matPrefix>badge</mat-icon>
              </mat-form-field>

              <!-- Teams Selection -->
              <div class="teams-section">
                <div class="teams-header">
                  <mat-icon>groups</mat-icon>
                  <span>Teams *</span>
                </div>

                <div class="teams-list" *ngIf="teams.length > 0">
                  <mat-checkbox 
                    *ngFor="let team of teams" 
                    [checked]="isTeamSelected(team.id)"
                    (change)="toggleTeam(team.id)"
                    class="team-checkbox">
                    {{ team.name }}
                  </mat-checkbox>
                </div>

                <div class="no-teams-message" *ngIf="teams.length === 0">
                  <p>No created team, please create one</p>
                  <button mat-button class="link-btn" (click)="navigateToTeamManagement()">
                    Go to Team Management
                  </button>
                </div>
              </div>

              <mat-form-field appearance="outline">
                <mat-label>Position</mat-label>
                <input matInput [(ngModel)]="formData.poste" name="poste" />
                <mat-icon matPrefix>work</mat-icon>
              </mat-form-field>

              <div class="form-actions">
                <button mat-raised-button class="btn-create" type="button" *ngIf="isCreating"
                  [disabled]="!userForm.valid || isLoading || !isFormValid()" (click)="createUser()">
                  <mat-icon>add</mat-icon>
                  <span>Create</span>
                </button>

                <button mat-raised-button class="btn-update" type="button" *ngIf="!isCreating"
                  [disabled]="!userForm.valid || isLoading || !isFormValid()" (click)="updateUser()">
                  <mat-icon>save</mat-icon>
                  <span>Update</span>
                </button>

                <button mat-raised-button class="btn-delete" type="button" *ngIf="!isCreating" [disabled]="isLoading"
                  (click)="deleteUser()">
                  <mat-icon>delete</mat-icon>
                  <span>Delete</span>
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </section>
    </div>
  </main>
</div>
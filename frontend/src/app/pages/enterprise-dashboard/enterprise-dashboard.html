<div class="enterprise-dashboard">
  <main class="main-content">
    <!-- Header Card -->
    <mat-card class="header-card" appearance="outlined">
      <mat-card-content>
        <div class="header-section">
          <div class="header-info">
            <h1>Enterprise Dashboard</h1>
            <p>Monitor team performance and KPIs</p>
          </div>
          <div class="header-action">
            <span class="export-label">Export :</span>
              
                <button color="primary" class= "export-btn" (click)="exportReportEmployeesPdf()">
                  <mat-icon>picture_as_pdf</mat-icon>
                </button>
  
                <button color="accent" class= "export-btn" (click)="exportReportEmployeesExcel()">
                  <mat-icon>table_view</mat-icon>
                </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Controls Bar -->
    <mat-card class="controls-card" appearance="outlined">
      <mat-card-content>
        <div class="controls-wrapper">
          <div class="kpi-tabs">
            <button mat-raised-button class="kpi-stat-btn" [class.active]="selectedKpi === 'attendance'"
              (click)="selectKpi('attendance')">
              <div class="kpi-btn-icon">
                <mat-icon>business_center</mat-icon>
              </div>
              <div class="kpi-btn-content">
                <span class="kpi-btn-label">Attendance</span>
                <span class="kpi-btn-value">{{ attendanceStats?.present || 0 }}</span>
              </div>
            </button>
            <button mat-raised-button class="kpi-stat-btn" [class.active]="selectedKpi === 'absenteeism'"
              (click)="selectKpi('absenteeism')">
              <div class="kpi-btn-icon">
                <mat-icon>person_off</mat-icon>
              </div>
              <div class="kpi-btn-content">
                <span class="kpi-btn-label">Absenteeism</span>
                <span class="kpi-btn-value">{{ absenteeismStats?.totalAbsences || 0 }}</span>
              </div>
            </button>
            <button mat-raised-button class="kpi-stat-btn" [class.active]="selectedKpi === 'productivity'"
              (click)="selectKpi('productivity')">
              <div class="kpi-btn-icon">
                <mat-icon>trending_up</mat-icon>
              </div>
              <div class="kpi-btn-content">
                <span class="kpi-btn-label">Productivity</span>
                <span class="kpi-btn-value">{{ productivityStats?.averageHours || 0 }}h</span>
              </div>
            </button>
          </div>

          <div class="filters">
            <mat-form-field appearance="outline" class="period-filter">
              <mat-label>Period</mat-label>
              <mat-select [(ngModel)]="selectedPeriod">
                <mat-option value="last_week">Last Week</mat-option>
                <mat-option value="quarter">Quarter</mat-option>
                <mat-option value="year">Year</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="team-filter">
              <mat-label>Team</mat-label>
              <mat-select [(ngModel)]="selectedTeam">
                <mat-option value="">All Teams</mat-option>
                <mat-option *ngFor="let team of teams" [value]="team">
                  {{ team }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <div class="report-export">

                
          </div>
            </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Main Content Area (scrollable) -->
    <div class="dashboard-content">
      <!-- Chart and Top List Section -->
      <div class="top-row">
        <!-- Chart Card -->
        <mat-card class="chart-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              <span>{{
                selectedKpi === 'attendance' ? 'Attendance' :
                selectedKpi === 'absenteeism' ? 'Absenteeism' :
                'Productivity'
                }} Overview</span>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-wrapper">
              <app-kpi-bar-chart [data]="barChartData" [selectedKpi]="selectedKpi">
              </app-kpi-bar-chart>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Top Performers Card -->
        <mat-card class="top-list-card" appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>leaderboard</mat-icon>
              <span>{{
                selectedKpi === 'absenteeism'
                ? 'Absenteeism Ranking'
                : selectedKpi === 'attendance'
                ? 'Attendance Ranking'
                : 'Productivity Ranking'
                }}</span>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="loading-spinner" *ngIf="loading">
              <mat-icon class="spin">refresh</mat-icon>
              <p>Loading data...</p>
            </div>

            <div *ngIf="!loading" class="top-list-content">
              <!-- Absenteeism List -->
              <div *ngIf="selectedKpi === 'absenteeism'">
                <div *ngIf="topAbsences.length > 0; else noData" class="ranking-list">
                  <div class="ranking-item" *ngFor="let item of topAbsences; let i = index">
                    <span class="rank">{{ i + 1 }}</span>
                    <span class="name">{{ item.name }}</span>
                    <mat-chip class="value-chip">{{ item.count }}</mat-chip>
                  </div>
                </div>
              </div>

              <!-- Attendance List -->
              <div *ngIf="selectedKpi === 'attendance'">
                <div *ngIf="topAttendance.length > 0; else noData" class="ranking-list">
                  <div class="ranking-item" *ngFor="let item of topAttendance; let i = index">
                    <span class="rank">{{ i + 1 }}</span>
                    <span class="name">{{ item.name }}</span>
                    <mat-chip class="value-chip">{{ item.count }}</mat-chip>
                  </div>
                </div>
              </div>

              <!-- Productivity List -->
              <div *ngIf="selectedKpi === 'productivity'">
                <div *ngIf="topProductivity.length > 0; else noData" class="ranking-list">
                  <div class="ranking-item" *ngFor="let item of topProductivity; let i = index">
                    <span class="rank">{{ i + 1 }}</span>
                    <span class="name">{{ item.name }}</span>
                    <mat-chip class="value-chip">{{ item.percent | number:'1.0-0' }}%</mat-chip>
                  </div>
                </div>
              </div>

              <ng-template #noData>
                <div class="empty-state">
                  <mat-icon>info</mat-icon>
                  <p>No data available</p>
                </div>
              </ng-template>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Details Table Section -->
      <mat-card class="details-card" appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>table_chart</mat-icon>
            <span>{{
              selectedKpi === 'productivity' ? 'Work Hours Details' :
              selectedKpi === 'attendance' ? 'Attendance Details' :
              'Absenteeism Details'
              }}</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="loading-spinner" *ngIf="loading">
            <mat-icon class="spin">refresh</mat-icon>
            <p>Loading data...</p>
          </div>

          <!-- Productivity Table -->
          <div *ngIf="!loading && selectedKpi === 'productivity'" class="table-wrapper">
            <table class="details-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Team</th>
                  <th>Working Time</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of filteredUsers">
                  <td>{{ user.nom }}</td>
                  <td>
                    <mat-chip class="team-chip">{{ user.equipe }}</mat-chip>
                  </td>
                  <td>
                    <span class="time-badge">{{ getTempsTravail(user.id) }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Attendance Table -->
          <div *ngIf="!loading && selectedKpi === 'attendance'" class="table-wrapper">
            <table class="details-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Team</th>
                  <th>Presence Rate</th>
                  <th>Avg Hours/Day</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of filteredUsers">
                  <td>{{ user.nom }}</td>
                  <td>
                    <mat-chip class="team-chip">{{ user.equipe }}</mat-chip>
                  </td>
                  <td>
                    <span class="rate-badge">{{ getPresenceRate(user.id) }}</span>
                  </td>
                  <td>
                    <span class="time-badge">{{ getTempsTravail(user.id) }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Absenteeism Table -->
          <div *ngIf="!loading && selectedKpi === 'absenteeism'" class="table-wrapper">
            <table class="details-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Team</th>
                  <th>Absence Days</th>
                  <th>Presence Rate</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of filteredUsers">
                  <td>{{ user.nom }}</td>
                  <td>
                    <mat-chip class="team-chip">{{ user.equipe }}</mat-chip>
                  </td>
                  <td>
                    <mat-chip class="absence-chip">{{ getAbsenceDays(user.id) }}</mat-chip>
                  </td>
                  <td>
                    <span class="rate-badge">{{ getPresenceRate(user.id) }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

    </div>
  </main>
</div>
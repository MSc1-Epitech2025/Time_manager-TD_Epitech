<div class="manager-dashboard">
  <main class="main-content">
    <!-- Header Card -->
    <mat-card class="header-card" appearance="outlined">
      <mat-card-content>
        <div class="profile-section">
          <div class="profile-info">
            <h1 class="user-name">{{ teamData?.name || 'Manager Dashboard' }}</h1>
            <p class="user-role">{{ teamData?.description || 'Team management and statistics' }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Team Overview Card (if team selected) -->
    <section class="team-overview-section" *ngIf="selectedTeamId && teamKpiData">
      <mat-card class="team-kpi-card" appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>analytics</mat-icon>
            Team Overview - {{ teamKpiData.teamName }}
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="loadingTeamKpi" class="loading-spinner">
            <mat-icon class="spin">refresh</mat-icon>
            <p>Loading team statistics...</p>
          </div>
          <div *ngIf="!loadingTeamKpi && teamKpiData" class="team-kpi-grid">
            <div class="kpi-item">
              <mat-icon class="kpi-icon">people</mat-icon>
              <div class="kpi-info">
                <span class="kpi-label">Team Size</span>
                <span class="kpi-value">{{ teamKpiData.headcount }}</span>
              </div>
            </div>
            <div class="kpi-item">
              <mat-icon class="kpi-icon">check_circle</mat-icon>
              <div class="kpi-info">
                <span class="kpi-label">Presence Rate</span>
                <span class="kpi-value">{{ teamKpiData.presenceRate | number:'1.1-1' }}%</span>
              </div>
            </div>
            <div class="kpi-item">
              <mat-icon class="kpi-icon">schedule</mat-icon>
              <div class="kpi-info">
                <span class="kpi-label">Avg Hours/Day</span>
                <span class="kpi-value">{{ teamKpiData.avgHoursPerDay | number:'1.1-1' }}h</span>
              </div>
            </div>
            <div class="kpi-item">
              <mat-icon class="kpi-icon">event_busy</mat-icon>
              <div class="kpi-info">
                <span class="kpi-label">Absence Rate</span>
                <span class="kpi-value">{{ teamKpiData.absenceRate | number:'1.1-1' }}%</span>
              </div>
            </div>
            <div class="kpi-item">
              <mat-icon class="kpi-icon">description</mat-icon>
              <div class="kpi-info">
                <span class="kpi-label">Reports Authored</span>
                <span class="kpi-value">{{ teamKpiData.reportsAuthored }}</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </section>

    <!-- Main Content Zone -->
    <section class="content-zone">
      <!-- Team Members Card -->
      <mat-card class="team-members-card" appearance="outlined">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>group</mat-icon>
            Team Members
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="team-members-content">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search for an employee</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="searchTerm"
              (ngModelChange)="filterEmployees()"
              placeholder="Employee name..."
            />
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <div *ngIf="loadingEmployees" class="loading-spinner">
            <mat-icon class="spin">refresh</mat-icon>
            <p>Loading employees...</p>
          </div>

          <div *ngIf="!loadingEmployees && filteredEmployees.length === 0" class="empty-state">
            <mat-icon>person_off</mat-icon>
            <p>No employees to display</p>
          </div>

          <div *ngIf="!loadingEmployees && filteredEmployees.length > 0" class="employee-list-wrapper">
            <mat-list class="employee-list">
              <mat-list-item
                *ngFor="let emp of filteredEmployees; let last = last"
                class="employee-item"
                [class.selected]="selectedEmployee?.id === emp.id"
                (click)="selectEmployee(emp)"
              >
                <div matListItemTitle class="employee-content">
                  <div class="employee-info">
                    <span class="employee-name">{{ emp.name }}</span>
                    <span class="employee-team">{{ emp.team || 'No team' }}</span>
                  </div>
                  <mat-chip-set>
                    <mat-chip class="presence-chip" *ngIf="getEmployeeKpiFromCache(emp.id)">
                      {{ getEmployeeKpiFromCache(emp.id)!.presenceRate | number:'1.1-1' }}% presence
                    </mat-chip>
                    <mat-chip class="presence-chip-muted" *ngIf="!getEmployeeKpiFromCache(emp.id)">
                      Loading...
                    </mat-chip>
                  </mat-chip-set>
                </div>
                <mat-divider *ngIf="!last"></mat-divider>
              </mat-list-item>
            </mat-list>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Employee KPI Card -->
      <mat-card class="employee-kpi-card" appearance="outlined" *ngIf="selectedEmployee">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>insights</mat-icon>
            {{ selectedEmployee.name }} - Quarterly Statistics
          </mat-card-title>
          <div>
            <button mat-icon-button class="export-btn" (click)="exportExcel()">
              <mat-icon>table_view</mat-icon>
            </button>
            <button mat-icon-button class="export-btn" (click)="exportPdf()">
              <mat-icon>picture_as_pdf</mat-icon>
            </button>
          </div>
        </mat-card-header>
        <mat-card-content class="employee-kpi-content">
          <div *ngIf="loadingKpi" class="loading-spinner">
            <mat-icon class="spin">refresh</mat-icon>
            <p>Loading employee statistics...</p>
          </div>

          <div *ngIf="!loadingKpi && employeeKpiData" class="kpi-details">
            <!-- KPI Bars -->
            <div class="kpi-bars">
              <!-- Presence Rate -->
              <div class="kpi-bar-item">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">Presence Rate</span>
                  <span class="kpi-bar-value">{{ employeeKpiData.presenceRate | number:'1.1-1' }}%</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="employeeKpiData.presenceRate"></mat-progress-bar>
              </div>

              <!-- Avg Hours/Day -->
              <div class="kpi-bar-item">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">Avg Hours/Day</span>
                  <span class="kpi-bar-value">{{ employeeKpiData.avgHoursPerDay | number:'1.1-1' }}h / 8h</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="(employeeKpiData.avgHoursPerDay / 8) * 100"></mat-progress-bar>
              </div>

              <!-- Overtime -->
              <div class="kpi-bar-item">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">Overtime</span>
                  <span class="kpi-bar-value">{{ Math.max(0, employeeKpiData.overtimeHours) | number:'1.1-1' }}h</span>
                </div>
                <mat-progress-bar class="overtime" mode="determinate" [value]="Math.min(Math.max(0, employeeKpiData.overtimeHours) / 10 * 100, 100)"></mat-progress-bar>
              </div>

              <!-- Punctuality -->
              <div class="kpi-bar-item">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">Punctuality</span>
                  <span class="kpi-bar-value">{{ 100 - employeeKpiData.punctuality.lateRate | number:'1.1-1' }}%</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="100 - employeeKpiData.punctuality.lateRate"></mat-progress-bar>
              </div>

              <!-- Avg Delay -->
              <div class="kpi-bar-item">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">Avg Delay</span>
                  <span class="kpi-bar-value">{{ employeeKpiData.punctuality.avgDelayMinutes | number:'1.0-0' }}min</span>
                </div>
                <mat-progress-bar class="warning" mode="determinate" [value]="Math.min((employeeKpiData.punctuality.avgDelayMinutes / 30) * 100, 100)"></mat-progress-bar>
              </div>

              <!-- Absence Days -->
              <div class="kpi-bar-item">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">Absence Days</span>
                  <span class="kpi-bar-value">{{ employeeKpiData.absenceDays | number:'1.1-1' }} days</span>
                </div>
                <mat-progress-bar class="danger" mode="determinate" [value]="Math.min((employeeKpiData.absenceDays / 5) * 100, 100)"></mat-progress-bar>
              </div>
            </div>

            <!-- Additional Info -->
            <div class="kpi-additional">
              <div class="info-card">
                <mat-icon>article</mat-icon>
                <div class="info-text">
                  <span class="info-label">Reports Authored</span>
                  <span class="info-value">{{ employeeKpiData.reportsAuthored }}</span>
                </div>
              </div>
              <div class="info-card">
                <mat-icon>inbox</mat-icon>
                <div class="info-text">
                  <span class="info-label">Reports Received</span>
                  <span class="info-value">{{ employeeKpiData.reportsReceived }}</span>
                </div>
              </div>
            </div>

            <!-- Absence Breakdown -->
            <div class="absence-breakdown" *ngIf="employeeKpiData?.absenceByType && employeeKpiData.absenceByType.length > 0">
              <h4>Absence Breakdown</h4>
              <mat-list class="breakdown-list">
                <mat-list-item *ngFor="let item of employeeKpiData.absenceByType; let last = last">
                  <div matListItemTitle class="breakdown-item">
                    <span class="breakdown-type">{{ item.type }}</span>
                    <span class="breakdown-days">{{ item.days | number:'1.1-1' }} days</span>
                  </div>
                  <mat-divider *ngIf="!last"></mat-divider>
                </mat-list-item>
              </mat-list>
            </div>
          </div>

          <div *ngIf="!loadingKpi && !employeeKpiData" class="empty-state">
            <mat-icon>bar_chart</mat-icon>
            <p>No KPI data available</p>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Placeholder when no employee selected -->
      <mat-card class="employee-kpi-card placeholder" appearance="outlined" *ngIf="!selectedEmployee && !loadingEmployees">
        <mat-card-content>
          <div class="empty-state">
            <mat-icon>person_search</mat-icon>
            <p>Select an employee to view their statistics</p>
          </div>
        </mat-card-content>
      </mat-card>
    </section>
  </main>
</div>
